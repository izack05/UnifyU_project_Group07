{% extends "layout/base.html" %}

{% block content %}

<style>
  /* Buttons */
  .btn-order-now {
    padding: 8px 12px;
    background-color: white;
    border: 1px solid #333;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .btn-order-now:hover {
    background-color: #333;
    color: white;
    transform: translateY(-2px);
  }

  .btn-order-later {
    padding: 8px 12px;
    background-color: #5c5b89;
    color: white;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .btn-order-later:hover {
    background-color: #454270;
    transform: translateY(-2px);
  }

  .btn-out-of-stock {
    padding: 8px 12px;
    background-color: gray;
    color: white;
    border: none;
    cursor: not-allowed;
  }

  /* Cart notification bubble */
  .cart-wrapper {
    position: relative;
    display: inline-block;
  }
  .cart-badge {
    position: absolute;
    top: -8px;
    right: -10px;
    background: red;
    color: white;
    font-size: 12px;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 50%;
    box-shadow: 0 0 4px rgba(0,0,0,0.3);
  }
  .btn-view-cart {
    background:#2e2e54; 
    color:white; 
    padding:8px 15px; 
    border-radius:6px; 
    text-decoration:none; 
    transition: all 0.3s ease;
  }
  .btn-view-cart:hover {
    background:#454270;
  }
  .btn-view-cart.disabled {
    background: gray;
    cursor: not-allowed;
  }

  /* Filters row */
  .filters-row {
    display:flex; 
    justify-content:center; 
    margin: 0 20px 20px;
    gap: 12px;
    flex-wrap: wrap;
  }
  .category-select {
    padding:8px 10px; 
    border:1px solid #e0e0e0; 
    border-radius:8px;
    background:#fff;
  }

  /* Search bar (pill style) */
  .menu-search {
    display: flex;
    justify-content: center;
    margin: 0;
  }
  .search-input {
    position: relative;
    width: 100%;
    max-width: 420px;
  }
  .search-input .search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #9aa0a6;
    font-size: 16px;
    pointer-events: none;
  }
  .search-input input {
    width: 100%;
    padding: 10px 14px 10px 36px; /* left padding for icon */
    border: 1px solid #e6e6e6;
    border-radius: 22px;
    outline: none;
    background: #ffffff;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
    transition: box-shadow .2s, border-color .2s;
    font-size: 14px;
    color: #2b2b2b;
  }
  .search-input input::placeholder {
    color: #9aa0a6;
  }
  .search-input input:focus {
    border-color: #cfd3d7;
    box-shadow: 0 0 0 3px rgba(92,91,137,0.08);
  }

  /* Grid cards */
  .category-title {
    text-align: center; 
    margin: 20px 0;
  }
  .category-title button {
    border: none; 
    padding: 8px 16px; 
    background-color: #eaeaea; 
    font-weight: bold; 
    font-size: 16px;
  }
  .food-grid {
    display: flex; 
    flex-wrap: wrap; 
    justify-content: center; 
    gap: 20px; 
    padding: 0 20px;
  }
  .food-card {
    flex: 0 0 30%; 
    max-width: 300px; 
    border: 1px solid #ddd; 
    border-radius: 8px; 
    overflow: hidden; 
    background-color: #fafafa; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    margin-bottom: 20px;
  }
  .food-thumb {
    position: relative;
  }
  .food-thumb img {
    width: 100%; 
    height: 200px; 
    object-fit: cover;
  }
  .food-badge {
    position: absolute; 
    bottom: 0; 
    right: 0; 
    background: #5c5b89; 
    color: white; 
    padding: 5px 10px; 
    font-size: 14px;
  }
  .food-body {
    padding: 15px; 
    text-align: center;
  }
  .empty-state {
    text-align:center; 
    color:#666; 
    margin: 8px 0 24px;
  }

  /* Flash messages */
  .flash-container {
    max-width: 920px;
    margin: 10px auto 16px;
    padding: 0 16px;
  }
  .flash {
    padding: 10px 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    border: 1px solid #e6e6e6;
    background: #f8f9fb;
    color: #2b2b2b;
    font-size: 14px;
  }
  .flash.success { background:#eaf6ed; border-color:#cfe9d6; color:#1f7a37; }
  .flash.error   { background:#fdeaea; border-color:#f3c2c2; color:#9d1c1c; }
  .flash.warning { background:#fff7e6; border-color:#ffe2a8; color:#8a5d00; }
  .flash.auth    { background:#eef1ff; border-color:#d9dffc; color:#2e3a8c; }
</style>

<!-- Cart Button -->
<div style="text-align: right; margin: 20px;">
  {% if cart and cart|length > 0 %}
    <a href="{{ url_for('cart') }}" class="btn-view-cart cart-wrapper">
      üõí View Cart
      <span class="cart-badge">{{ cart|length }}</span>
    </a>
  {% else %}
    <span class="btn-view-cart disabled">üõí View Cart</span>
  {% endif %}
</div>

<!-- Flash messages (render them on this page) -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- Filters: Search + Category -->
<div class="filters-row">
  <!-- Search bar -->
  <form method="get" action="{{ url_for('canteen_home') }}" class="menu-search" style="flex:1; min-width:260px; max-width:420px;">
    <div class="search-input">
      <span class="search-icon" aria-hidden="true">üîç</span>
      <input
        type="text"
        name="q"
        value="{{ search_query or '' }}"
        placeholder="Search in menu"
        autocomplete="off"
        aria-label="Search in menu"
      />
    </div>

    {# Preserve current category when searching #}
    {% if selected_category %}
      <input type="hidden" name="category" value="{{ selected_category }}">
    {% endif %}
    {# Preserve current price range if provided #}
    {% if sel_min is defined and sel_max is defined %}
      <input type="hidden" name="price_min" value="{{ sel_min }}">
      <input type="hidden" name="price_max" value="{{ sel_max }}">
    {% endif %}
  </form>

  <!-- Category dropdown -->
  <form method="get" action="{{ url_for('canteen_home') }}">
    <select name="category" class="category-select" onchange="this.form.submit()">
      <option value="" {% if not selected_category %}selected{% endif %}>All</option>
      {% for cat in categories %}
        <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>{{ cat }}</option>
      {% endfor %}
    </select>

    {# Preserve current search and price when changing category #}
    {% if search_query %}
      <input type="hidden" name="q" value="{{ search_query }}">
    {% endif %}
    {% if sel_min is defined and sel_max is defined %}
      <input type="hidden" name="price_min" value="{{ sel_min }}">
      <input type="hidden" name="price_max" value="{{ sel_max }}">
    {% endif %}
    <noscript><button type="submit" class="btn-order-now">Apply</button></noscript>
  </form>
</div>

{% if selected_category %}
  <!-- Selected category header -->
  <div class="category-title">
    <button>{{ selected_category }}</button>
  </div>

  {% set items_list = grouped_items.get(selected_category, []) %}
  {% if not items_list %}
    <p class="empty-state">No items found.</p>
  {% else %}
    <div class="food-grid">
      {% for item in items_list %}
        <div class="food-card">
          <div class="food-thumb">
            <img src="{{ url_for('static', filename='canteen/' ~ item.image) }}" alt="{{ item.name }}">
            <div class="food-badge">
              {% if item.stock > 0 %}Available{% else %}Out of Stock{% endif %}
            </div>
          </div>
          <div class="food-body">
            <h3 style="margin: 10px 0; color: #333;">{{ item.name }}</h3>
            <p style="margin: 5px 0; font-size: 14px;">Per item</p>
            <p style="margin: 5px 0; font-weight: bold;">BDT {{ item.price }}</p>

            {% if item.stock > 0 %}
              <form action="{{ url_for('add_to_cart', food_id=item.id) }}" method="POST" style="margin-top: 10px;">
                <button type="submit" class="btn-order-now">Order Now</button>
              </form>
              <button class="btn-order-later" style="margin-top: 8px;">Order for Later</button>
            {% else %}
              <button disabled class="btn-out-of-stock" style="margin-top: 10px;">Out of Stock</button>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% else %}
  {% if not grouped_items %}
    <p class="empty-state">No items found.</p>
  {% else %}
    {% for category, items in grouped_items.items() %}
      <div class="category-title">
        <button>{{ category }}</button>
      </div>

      {% if not items %}
        <p class="empty-state">No items found.</p>
      {% else %}
        <div class="food-grid">
          {% for item in items %}
            <div class="food-card">
              <div class="food-thumb">
                <img src="{{ url_for('static', filename='canteen/' ~ item.image) }}" alt="{{ item.name }}">
                <div class="food-badge">
                  {% if item.stock > 0 %}Available{% else %}Out of Stock{% endif %}
                </div>
              </div>
              <div class="food-body">
                <h3 style="margin: 10px 0; color: #333;">{{ item.name }}</h3>
                <p style="margin: 5px 0; font-size: 14px;">Per item</p>
                <p style="margin: 5px 0; font-weight: bold;">BDT {{ item.price }}</p>

                {% if item.stock > 0 %}
                  <form action="{{ url_for('add_to_cart', food_id=item.id) }}" method="POST" style="margin-top: 10px;">
                    <button type="submit" class="btn-order-now">Order Now</button>
                  </form>
                  <button class="btn-order-later" style="margin-top: 8px;">Order for Later</button>
                {% else %}
                  <button disabled class="btn-out-of-stock" style="margin-top: 10px;">Out of Stock</button>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endfor %}
  {% endif %}
{% endif %}

{% endblock %}
