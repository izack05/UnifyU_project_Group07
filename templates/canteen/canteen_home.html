{% extends "layout/base.html" %}

{% block content %}
<style>
  /* Buttons */
  .btn-order-now {
    padding: 8px 12px;
    background-color: white;
    border: 1px solid #333;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .btn-order-now:hover {
    background-color: #333;
    color: white;
    transform: translateY(-2px);
  }

  .btn-out-of-stock {
    padding: 8px 12px;
    background-color: gray;
    color: white;
    border: none;
    cursor: not-allowed;
  }

  .cart-wrapper { position: relative; display: inline-block; }
  .cart-badge {
    position: absolute; top: -8px; right: -10px;
    background: red; color: white; font-size: 12px;
    font-weight: bold; padding: 2px 6px; border-radius: 50%;
    box-shadow: 0 0 4px rgba(0,0,0,0.3);
  }
  .btn-view-cart {
    background:#2e2e54; color:white; padding:8px 15px; border-radius:6px;
    text-decoration:none; transition: all 0.3s ease;
  }
  .btn-view-cart:hover { background:#454270; }
  .btn-view-cart.disabled { background: gray; cursor: not-allowed; }

  /* Filters & search */
  .filters-row { display:flex; justify-content:center; margin: 0 20px 20px; gap: 12px; flex-wrap: wrap; }
  .category-select { padding:8px 10px; border:1px solid #e0e0e0; border-radius:8px; background:#fff; }
  .menu-search input, .menu-search select, .menu-search button { font-size:14px; }

  /* Food grid & cards */
  .category-title { text-align: center; margin: 20px 0; }
  .category-title button { border: none; padding: 8px 16px; background-color: #eaeaea; font-weight: bold; font-size: 16px; }
  .food-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; padding: 0 20px; }
  .food-card { flex: 0 0 30%; max-width: 300px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background-color: #fafafa; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
  .food-thumb { position: relative; }
  .food-thumb img { width: 100%; height: 200px; object-fit: cover; }
  .food-badge { position: absolute; bottom: 0; right: 0; background: #5c5b89; color: white; padding: 5px 10px; font-size: 14px; }
  .food-body { padding: 15px; text-align: center; }
  .empty-state { text-align:center; color:#666; margin: 8px 0 24px; }

  /* Flash messages */
  .flash-container { max-width: 920px; margin: 10px auto 16px; padding: 0 16px; }
  .flash { padding: 10px 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e6e6e6; background: #f8f9fb; color: #2b2b2b; font-size: 14px; }
  .flash.success { background:#eaf6ed; border-color:#cfe9d6; color:#1f7a37; }
  .flash.error { background:#fdeaea; border-color:#f3c2c2; color:#9d1c1c; }
  .flash.warning { background:#fff7e6; border-color:#ffe2a8; color:#8a5d00; }
  .flash.auth { background:#eef1ff; border-color:#d9dffc; color:#2e3a8c; }

  /* Quantity buttons */
  .qty-btn { padding:4px 10px; margin:0 2px; }
  .disabled { opacity: .6; cursor: not-allowed; }
</style>

<!-- Cart and Orders Buttons -->
<div style="text-align: right; margin: 20px; display: flex; gap: 10px; justify-content: flex-end; align-items: center;">
  {% if cart and total_quantity > 0 %}
    <a href="{{ url_for('cart') }}" class="btn-view-cart cart-wrapper">
      ðŸ›’ View Cart
      <span class="cart-badge">{{ total_quantity }}</span>
    </a>
  {% else %}
    <span class="btn-view-cart disabled">ðŸ›’ View Cart</span>
  {% endif %}
  <a href="{{ url_for('student_orders') }}" class="btn-view-cart cart-wrapper" style="margin-left: 10px;"> View Orders</a>
</div>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- Filters Form -->
<form method="get" action="{{ url_for('canteen_home') }}" class="menu-search filters-row">
    <input type="text" name="q" placeholder="Search by name or description" value="{{ search_query or '' }}" />

    <select name="category" class="category-select">
        <option value="">All Categories</option>
        {% for cat in categories %}
            <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>{{ cat }}</option>
        {% endfor %}
    </select>

    <input type="number" name="min_price" placeholder="Min Price" value="{{ min_price or '' }}" style="width:100px;" />
    <input type="number" name="max_price" placeholder="Max Price" value="{{ max_price or '' }}" style="width:100px;" />

    <button type="submit" class="btn-order-now">Apply Filters</button>
</form>

<!-- Food Items -->
{% for category, items in grouped_items.items() %}
  <div class="category-title"><button>{{ category }}</button></div>

  {% if not items %}
    <p class="empty-state">No items found.</p>
  {% else %}
    <div class="food-grid">
      {% for item in items %}
        <div class="food-card">
          <div class="food-thumb">
            <img src="{{ url_for('static', filename='canteen/' ~ item.image) }}" alt="{{ item.name }}">
            <div class="food-badge">{% if item.stock > 0 %}Available{% else %}Out of Stock{% endif %}</div>
          </div>
          <div class="food-body">
            <h3 style="margin:10px 0; color:#333;">{{ item.name }}</h3>
            <p style="margin:5px 0; font-weight:bold;">BDT {{ item.price }}</p>

            {% if item.stock > 0 %}
              {% set qty = session.get('temp_qty_' ~ item.id, 0) %}
              <form action="{{ url_for('canteen_item', food_id=item.id) }}" method="POST" style="display:flex; justify-content:center; align-items:center; gap:6px; flex-wrap:wrap;">
                {% if csrf_token %}{{ csrf_token() }}{% endif %}
                <button type="submit" name="action" value="decrease" class="qty-btn" {% if qty <= 0 %}disabled{% endif %}>âˆ’</button>
                <span style="min-width:28px; text-align:center;">{{ qty }}</span>
                <button type="submit" name="action" value="increase" class="qty-btn">+</button>
                <input type="hidden" name="quantity" value="{{ qty }}">
                <button type="submit" name="action" value="add" class="btn-order-now">Add to Cart</button>
              </form>
            {% else %}
              <button class="btn-out-of-stock" disabled>Out of Stock</button>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endfor %}
{% endblock %}
